
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Buffer Overflow - nameless</title>
	<meta name="author" content="khakimov">

	
	<meta name="description" content="I&#8217;m very interesting in research paper and want to know better what computer security research is like. I found Vitaly Shmatikov and his course &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="nameless" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">nameless</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:khakimov.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:khakimov.github.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Buffer Overflow</h1>
	<div class="entry-content"><p>I&#8217;m very interesting in research paper and want to know better what computer security research is like. I found Vitaly Shmatikov and his course about great papers in Computer Security and decided to try each weekend read and write about one paper.</p>

<p>Vitaly Shmatikov is one of most interesting person for me in computer security and privacy. He got his PhD at Stanford and his thesis was &#8221;<a href="https://www.cs.utexas.edu/~shmat/shmat_tcs.pdf">Finite-State Analysis of Security Protocols</a>&#8221;, also his prof at Stanford was John C. Mitchell.</p>

<p>So, today I want to start with Buffer Overflow and here is paper 1999 by Crispin Cowan, Perry Wagle, Calton Pu,Steve Beattie, and Jonathan Walpole.</p>

<p><a title="View Overflow on Scribd" href="http://www.scribd.com/doc/113583111/Overflow" style="margin: 12px auto 6px auto; font-family: Helvetica,Arial,Sans-serif; font-style: normal; font-variant: normal; font-weight: normal; font-size: 14px; line-height: normal; font-size-adjust: none; font-stretch: normal; -x-system-font: none; display: block; text-decoration: underline;">Overflow</a><iframe class="scribd_iframe_embed" src="http://www.scribd.com/embeds/113583111/content?start_page=1&view_mode=scroll&access_key=key-39aierbs22vhrn0azpl" data-auto-height="true" data-aspect-ratio="0.772727272727273" scrolling="no" id="doc_1657" width="100%" height="600" frameborder="0"></iframe></p>

<p>Btw, in this paper they metioned about Morris Worm and early versions of using buffer overflow and I found the peace of Morris Worm&#8217;s overflow:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>; VAX binary code fragment from the Morris Internet Worm.
</span><span class='line'>; Downloaded to the fingerd serving process via the gets() hole.
</span><span class='line'>; Performs execve(“/bin/sh”,0,0)
</span><span class='line'>pushl $0068732f   ; last half of name: "/sh\0"
</span><span class='line'>pushl $6e69622f   ; first half of name: "/bin"
</span><span class='line'>mov   sp,r10            ; pointer to the string
</span><span class='line'>pushl $0          ; 3rd parameter: environment = null
</span><span class='line'>pushl $0          ; 2nd parameter: args = null
</span><span class='line'>pushl r10         ; 1st parameter: pointer to the executable name
</span><span class='line'>pushl $3          ; 3 parameters on the stack
</span><span class='line'>movl  sp,ap       ; ArgumentPointer points to arguments
</span><span class='line'>chmk  $3b         ; SoftwareException 0x3B = EXECVE call</span></code></pre></td></tr></table></div></figure>


<p>It used a buffer overflow against the fingerd daemon. Other worms also often use buffer overflow to compromise the machine. CodeRed used overflow in MS-IIS server, SQL Slammer - overflow in MSSQL server, Sasser overflow in Windows LSASS, Conficker used overflow in Windows RPC and famous Stuxnet used several 0day overflows and same Windows RPC as Conficker. Looks like Buffer Overflow is the basis of many software vulnerabilities and can be maliciously exploited.</p>

<p>In computer security and programming, a buffer overflow, or buffer overrun, is an anomaly where a program, while writing data to a buffer, overruns the buffer&#8217;s boundary and overwrites adjacent memory. <strong>Buffer</strong> is a data storage area inside computer memory (stack or heap).</p>

<p>Suppose we have Webserver contain this function</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>    <span class="c1">// allocate 100 bytes on stack </span>
</span><span class='line'>      <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>   <span class="c1">// copy argument into local buffer</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>strcpy</strong> does not check whether the string at *s contains fewer than 126 characters and if a string longer than 126 bytes is copied into buffer, it will overwrite adjacent stack locations.</p>

<p><img src="http://pix.am/ou9H.png" alt="" />
<img src="http://pix.am/HSH8.png" alt="" /></p>

<p>We overflow the return address and set address of attack code (the value in the RET position must point to the beginning of attack assembly code in the buffer, otherwise application will crash with segmentation violation).</p>

<p>Other exampe from <strong>Hacking</strong> book</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">char</span> <span class="n">buffer_one</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">buffer_two</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer_one</span><span class="p">,</span> <span class="s">&quot;one&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer_two</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[BEFORE] buffer_two is at %p contain </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_two</span><span class="p">,</span> <span class="n">buffer_two</span><span class="p">);</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[BEFORE] buffer_one is at %p contain </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_one</span><span class="p">,</span> <span class="n">buffer_one</span><span class="p">);</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[BEFORE] value is at %p and is %d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">[STRCPY] copying %d bytes into buffer_two</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
</span><span class='line'>   <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer_two</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[AFTER] buffer_two is at %p and contains </span><span class="se">\&#39;</span><span class="s">%s</span><span class="se">\&#39;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_two</span><span class="p">,</span> <span class="n">buffer_two</span><span class="p">);</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[AFTER] buffer_one is at %p and contains </span><span class="se">\&#39;</span><span class="s">%s</span><span class="se">\&#39;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer_one</span><span class="p">,</span> <span class="n">buffer_one</span><span class="p">);</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[AFTER] value is at %p and is %d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">overflow</span><span class="err">@</span><span class="n">hacking</span><span class="o">:~/</span><span class="n">booksrc</span> <span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="n">overflow_example</span> <span class="n">overflow_example</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="n">overflow</span><span class="err">@</span><span class="n">hacking</span><span class="o">:~/</span><span class="n">booksrc</span> <span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">overflow_example</span> <span class="mi">1234567890</span>
</span><span class='line'><span class="p">[</span><span class="n">BEFORE</span><span class="p">]</span> <span class="n">buffer_two</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0xbffff7f0</span> <span class="n">and</span> <span class="n">contains</span> <span class="err">&#39;</span><span class="n">two</span><span class="err">&#39;</span>
</span><span class='line'><span class="p">[</span><span class="n">BEFORE</span><span class="p">]</span> <span class="n">buffer_one</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0xbffff7f8</span> <span class="n">and</span> <span class="n">contains</span> <span class="err">&#39;</span><span class="n">one</span><span class="err">&#39;</span>
</span><span class='line'><span class="p">[</span><span class="n">BEFORE</span><span class="p">]</span> <span class="n">value</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0xbffff804</span> <span class="n">and</span> <span class="n">is</span> <span class="mi">5</span> <span class="p">(</span><span class="mh">0x00000005</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="n">STRCPY</span><span class="p">]</span> <span class="n">copying</span> <span class="mi">10</span> <span class="n">bytes</span> <span class="n">into</span> <span class="n">buffer_two</span>
</span><span class='line'><span class="p">[</span><span class="n">AFTER</span><span class="p">]</span> <span class="n">buffer_two</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0xbffff7f0</span> <span class="n">and</span> <span class="n">contains</span> <span class="err">&#39;</span><span class="mi">1234567890</span><span class="err">&#39;</span>
</span><span class='line'><span class="p">[</span><span class="n">AFTER</span><span class="p">]</span> <span class="n">buffer_one</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0xbffff7f8</span> <span class="n">and</span> <span class="n">contains</span> <span class="err">&#39;</span><span class="mi">90</span><span class="err">&#39;</span>
</span><span class='line'><span class="p">[</span><span class="n">AFTER</span><span class="p">]</span> <span class="n">value</span> <span class="n">is</span> <span class="n">at</span> <span class="mh">0xbffff804</span> <span class="n">and</span> <span class="n">is</span> <span class="mi">5</span> <span class="p">(</span><span class="mh">0x00000005</span><span class="p">)</span>
</span><span class='line'><span class="n">overflow</span><span class="err">@</span><span class="n">hacking</span><span class="o">:~/</span><span class="n">booksrc</span> <span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Probably you will try to check this code on your computer (macos in my case), but <a href="https://en.wikipedia.org/wiki/Buffer_overflow_protection">buffer overflow protection</a> was included in release GCC 4.1 and you have to use <strong>-fno-stack-protector</strong> to compile your code. (hmm, i&#8217;m still getting error Program received signal SIGABRT, Aborted. which kills the proccess, couple clicks with google told me to recompile gcc. Seems now it&#8217;s not easy to write bogus code =)). In this case I have virtual machine with 32-bit pretty old Ubuntu.</p>

<figure class='code'><figcaption><span>t.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt; </span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">Q</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Q</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The return address in a stack frame can be located by undestanding how the stack frame is created. This process begins in the main() function even before the function call.</p>

<p>Couple things you have to know about the stack. The stack is used to pass prcedure arguments, <strong>to store return information</strong>, to save registers for later restoration and for local storage. The portion of the stack allocated for a single procedure call is called a <strong>stack frame</strong>. $EBP register serving as the <strong>frame pointer</strong> and register $ESP serving as the <strong>stack pointer</strong>.</p>

<p>The main idea is when main() calls Q() the <strong>return</strong> address within main() where the program should resume execution when it returns from Q. If somebody can overwrite return address it can jump or/and execute other code.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/4/4f/Stack_Overflow_2.png" alt="" /></p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/9/93/Stack_Overflow_3.png" alt="" /></p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/c/c3/Stack_Overflow_4.png" alt="" /></p>

<p>More details you can find in the paper above. If you are interesting in roots of the problem and how actually stack/heap works, I highly recommend to read the book <a href="http://www.amazon.com/Computer-Systems-A-Programmers-Perspective/dp/013034074X">Computer System: A Programmer&#8217;s Perspective by Bryant and O&#8217;Hallaron</a>.</p>

<p>The first step is always the hardest. Will see how long I hold out.</p>


  	<div class="addthis_toolbox addthis_default_style ">
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>

	<a class="addthis_button_tweet"></a>
	
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>


	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-11-20T23:17:00-06:00" pubdate data-updated="true">Nov 20<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/computer-security/'>computer security</a>, <a class='category' href='/blog/categories/great-papers/'>great papers</a>, <a class='category' href='/blog/categories/research/'>research</a>


</div>
	
</div></article>
<div class="share">
<div id="hypercomments_widget"></div><script type="text/javascript">
var _hcp = _hcp || {};
_hcp.widget_id = 2313;
_hcp.widget = "Stream";
(function() { 
var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://widget.hypercomments.com/apps/js/hc.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hcc, s.nextSibling); 
})();</script>
</div>

</div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    khakimov

</footer>
	<script src="/javascripts/slash.js"></script>
<script type="text/javascript">
var _hcp = _hcp || {};
_hcp.widget_id = 2313;
_hcp.widget = "Stream";
(function() { 
var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://widget.hypercomments.com/apps/js/hc.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hcc, s.nextSibling); 
})();</script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-31552911-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>