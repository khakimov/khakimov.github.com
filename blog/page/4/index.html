
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>curious and driven</title>
	<meta name="author" content="khakimov">

	
	<meta name="description" content="CS106B is awesome! Today was a lecture about Linked List as I&#8217;ve already mention about this Data structures. Linked lists are among the &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="curious and driven" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">curious and driven</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:khakimov.github.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:khakimov.github.com">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h1 class="title"><a href="/blog/2012/05/11/back-to-school-linked-list-with-ruby/">Back to School: Linked List With Ruby</a></h1>
	<div class="entry-content">
		<p>CS106B is awesome! Today was a lecture about <a href="/blog/2012/04/27/data-structure/">Linked List</a> as I&#8217;ve already mention about this Data structures.</p>

<p>Linked lists are among the simplest and most common data structures. They can be used to implement several other common abstract data types, including stacks, queues, associative arrays, and symbolic expressions, though it is not uncommon to implement the other data structures directly without using a list as the basis of implementation. <a href="http://en.wikipedia.org/wiki/Linked_list">wikipedia</a></p>

<p>With C++ we can represent a cell in the linked list as a structure, like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Cell</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">string</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Cell</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>in Ruby we can also use <a href="http://www.ruby-doc.org/core-1.9.3/Struct.html">Struct</a> and code our LinkedList will be like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># create a struct with :value and :next</span>
</span><span class='line'><span class="no">Cell</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:value</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create a head of our list</span>
</span><span class='line'><span class="n">list</span> <span class="o">=</span> <span class="no">Cell</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;head. hi&quot;</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># method which create one more cell and return the struct</span>
</span><span class='line'><span class="k">def</span> <span class="nf">linked_list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="no">Cell</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># method which recursively print value until the asteroid...</span>
</span><span class='line'><span class="k">def</span> <span class="nf">recursive_print</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">p</span> <span class="n">list</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'>  <span class="n">recursive_print</span><span class="p">(</span><span class="n">list</span><span class="o">.</span><span class="n">next</span><span class="p">)</span> <span class="k">unless</span> <span class="n">list</span><span class="o">.</span><span class="n">next</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create Linked List</span>
</span><span class='line'><span class="c1"># #&lt;struct Cell value=10, ... next=#&lt;struct Cell value=1, next=#&lt;struct Cell value=&quot;head. hi&quot;, next=nil&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">10</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="n">list</span> <span class="o">=</span> <span class="n">linked_list</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">recursive_print</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="c1"># print out recursively our list</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s test Linked List and Arrays to insert value in the top.</p>

<figure class='code'><figcaption><span>simple_bench.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># create a struct with :value and :next</span>
</span><span class='line'><span class="no">Cell</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:value</span><span class="p">,</span> <span class="ss">:next</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create a head of our list</span>
</span><span class='line'><span class="n">list</span> <span class="o">=</span> <span class="no">Cell</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;head. hi&quot;</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># array</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># method which create one more cell and return the struct</span>
</span><span class='line'><span class="k">def</span> <span class="nf">linked_list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="no">Cell</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># simple benchmark timer. t1 - t2 = waiting time ;)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">bench</span> <span class="n">type</span>
</span><span class='line'>  <span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>  <span class="k">yield</span>
</span><span class='line'>  <span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>  <span class="nb">p</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;s took </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">bench</span> <span class="p">(</span><span class="s2">&quot;array&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="mi">100000</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">a</span><span class="o">.</span><span class="n">insert</span> <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">}</span> <span class="c1"># O(n)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">bench</span> <span class="p">(</span><span class="s2">&quot;linked list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="mi">100000</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">list</span> <span class="o">=</span> <span class="n">linked_list</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># O(1)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># results</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># &quot;array&#39;s took 2.661794s&quot;</span>
</span><span class='line'><span class="c1"># &quot;linked list&#39;s took 0.050272s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m not sure this is good example of benchmarking, will check it later. What doest it all mean? If you want insert value in the head of array, array gets a new array and move everything over every time when you insert something.</p>

<p><strong>[1, 2, 3, 4, 5, 6]</strong> -> inserting <strong>10071983</strong> value -> <strong>[10071983, 1, 2, 3, 4, 5, 6]</strong>, so now inserting an element into a top of array can be very costly - O(n) because everytime move everything over.</p>

<p>with linked list you just create cell with element and pointer on next cell. <strong>[1, pointer->nil]</strong> and if we want to add new element, we just set pointer like <strong>[10071983, pointer->next]</strong> where pointer->next is reference to <strong>[1, nil]</strong>. Of course Arrays are cool, because you can do many other things faster than linked list (trade offs), but don&#8217;t forget about Algorithmic Analysis where you can find what will be faster to use in your case.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-11T13:27:00-07:00" pubdate data-updated="true">May 11<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/cs/'>cs</a>, <a class='category' href='/blog/categories/data-sctructure/'>data sctructure</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/05/07/playing-with-rails/">Playing With Rails</a></h1>
	<div class="entry-content">
		<p>Only with Rails I&#8217;ve realized meaning of the word REST and how RESTful Controller works. When you will understand CRUD and Scaffolding, you will easily create simple application, like one more blog or twitter clone ;)</p>

<p>CRUD = CREATE, SELECT, UPDATE, DELETE in database and create, show, update and destroy in Rails.</p>

<p>When we are using create HTTP sends POST request. For destroy - DELETE request. update - PUT and show simple GET. This is very useful, because you don&#8217;t need to create different paths for object you going to work with. For example,</p>

<ul>
<li>create - will send POST /users</li>
<li>update - will send PUT /users/1</li>
<li>destroy - will send DELETE /users/1</li>
<li>show - will send /users/1</li>
</ul>


<p>I haven&#8217;t seen this in Django, only with Rails realized this simplicity of REST.</p>

<p>I know, I know what already exists a tons of tutorials with Rails, but because it&#8217;s good to repeat some fundomental stuff I&#8217;m also going to create one more. I&#8217;m going to build simple application called <strong>Morning Pages</strong>. I read the book <em>Pragmatic Thinking and Learning</em> and author describes one technic with same name &#8220;Morning Pages&#8221; when you wake up and start writing just random things from your head.</p>

<p><img src="http://pix.am/CuqHl.png" alt="" /></p>

<p>Specs:
morning page has title, body, created and updated time.</p>

<p>We want to be able:</p>

<ul>
<li>add new morning page</li>
<li>edit morning page</li>
<li>delete morning page</li>
<li>show morning page</li>
</ul>


<p>Let&#8217;s start:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rails new morning_page
</span><span class='line'>
</span><span class='line'># here is trick with [plural and singular](http://stackoverflow.com/questions/646951/singular-or-plural-controller-and-helper-names-in-rails).
</span><span class='line'>rails generate controller MorningPages 
</span><span class='line'>rails generate model MorningPage title:string body:text
</span><span class='line'>
</span><span class='line'>rake db:migrate</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m not using scaffold here, because I think will be better to go throught step-by-step will be better to understand how it works. Scanffolding allows you create</p>

<ul>
<li>4 views (index, show, new and edit)</li>
<li>a layout file for all of those views</li>
<li>a stylesheet for all of those views</li>
<li>a model</li>
<li>a data migration to establish the tables needed for the model</li>
<li>a controller to send data</li>
<li>an empty file for helper methods</li>
<li>a new route that will map user requests to the controller</li>
</ul>


<p>a lot isnt&#8217;s? but we are not looking for easy way ;) of course when you will understand how each part works, you can use scaffold. In our case we already created controller MorningPage and model with same name. Now I&#8217;m going insert some test data in a database. Open db/seed.db and add few records:</p>

<figure class='code'><figcaption><span>seed.db</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Create few records&quot;</span>
</span><span class='line'><span class="no">MorningPage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s1">&#39;Day 1&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="s1">&#39;Good morning! Sunny day!&#39;</span><span class="p">)</span>
</span><span class='line'><span class="no">MorningPage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s1">&#39;Day 2&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="s1">&#39;Hello! Such a wonderful day.&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>seed.db</strong> is just a ruby script, so you can write here anything you want in ruby like cycles, parsing method or whatever. Then you should run <strong>rake db:seed</strong> to execute your&#8217;s seed.db. Ok, nice, now we have two records in our database and we can also check this with rails console</p>

<figure class='code'><figcaption><span>seed.db</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">khakimov</span> <span class="k">in</span> <span class="o">~</span><span class="sr">/Projects/</span><span class="n">current</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">rails</span><span class="o">/</span><span class="n">rails_app</span><span class="o">/</span><span class="n">morning</span> <span class="n">on</span> <span class="n">master</span>
</span><span class='line'><span class="err">±</span> <span class="n">rails</span> <span class="n">console</span>
</span><span class='line'><span class="no">Loading</span> <span class="n">development</span> <span class="n">environment</span> <span class="p">(</span><span class="no">Rails</span> <span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="o">[</span><span class="c1">#&lt;MorningPage id: 1, title: &quot;Day 1&quot;, body: &quot;Good morning! Sunny day!&quot;, created_at: &quot;2012-05-08 23:29:58&quot;, updated_at: &quot;2012-05-09 20:50:56&quot;&gt;, ...]</span>
</span></code></pre></td></tr></table></div></figure>


<p>so far, so good with model. move on to controller. We don&#8217;t have any action methods yet, like index, show, edit&#8230; Open app/controllers/morning_pages_controller.rb and add index, show, new, edit, create, update and destroy:</p>

<figure class='code'><figcaption><span>morining_page_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MorningPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>      <span class="vi">@messages</span> <span class="o">=</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>      <span class="vi">@message</span> <span class="o">=</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">new</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">edit</span>
</span><span class='line'>      <span class="vi">@morning_page</span> <span class="o">=</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>      <span class="c1">#logger.debug(params)</span>
</span><span class='line'>      <span class="vi">@morning_page</span> <span class="o">=</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:morning_page</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@morning_page</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="vi">@morning_page</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">&quot;new&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>      <span class="vi">@morning_page</span> <span class="o">=</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@morning_page</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:morning_page</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="vi">@morning_page</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="ss">:edit</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>      <span class="vi">@morning_page</span> <span class="o">=</span> <span class="no">MorningPage</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@morning_page</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>          <span class="n">redirect_to</span> <span class="n">morning_page_index_path</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;fail&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>in our config/routes.rb file don&#8217;t forget to add which will allow route request to the methods</p>

<figure class='code'><figcaption><span>morining_page_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">root</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;morning_pages#index&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">resources</span> <span class="ss">:morning_pages</span>
</span></code></pre></td></tr></table></div></figure>


<p>ok, now our application can route request, but we can&#8217;t check it without layouts. So, create views/morning_pages/ with files:</p>

<figure class='code'><figcaption><span>edit.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= form_for(@morning_page, :url =&gt; {:action =&gt; :update}) do |f| %&gt;
</span><span class='line'>  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;text_field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= f.label :title %&gt;
</span><span class='line'>      <span class="err">&lt;</span>%= f.text_field :title, :placeholder =&gt; &#39;Title&#39;, :size =&gt; &#39;auto&#39; %&gt;
</span><span class='line'>  <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;text_field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= f.label :body %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= f.text_area :body, :placeholder =&gt; &#39;Body&#39; %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>%= f.submit &quot;Modify Page&quot;, :class =&gt; &quot;buttonize submit_form&quot;, :id =&gt; &#39;form_submitter&#39; %&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>index.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;content home clearfix users&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;</span>% if !@messages.blank? %&gt;
</span><span class='line'>  <span class="err">&lt;</span>% for item in @messages %&gt;
</span><span class='line'>    <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;post clearfix &lt;%= cycle(&#39;jared&#39;,&#39;daslee&#39;)%&gt;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="err">&lt;</span>%= item.updated_at.to_formatted_s(:long) %&gt;
</span><span class='line'>          <span class="err">&lt;</span>%= link_to(item.title, morning_page_path(item), :class =&gt; &#39;clearfix&#39;) %&gt;
</span><span class='line'>          <span class="err">&lt;</span>%= link_to(&quot;edit&quot;, edit_morning_page_path(item)) %&gt; |
</span><span class='line'>          <span class="err">&lt;</span>%= link_to(&quot;delete&quot;, morning_page_path(item),
</span><span class='line'>              :confirm =&gt; &#39;Are you sure?&#39;, :method =&gt; :delete) %&gt;
</span><span class='line'>      <span class="nt">&lt;/p&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="err">&lt;</span>% else %&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;</span>% end %&gt;
</span><span class='line'>      <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;post clearfix&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>new.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= form_for(:morning_page, :url =&gt; {:action =&gt; :create}) do |f| %&gt;
</span><span class='line'>  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;text_field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= f.label :title %&gt;
</span><span class='line'>      <span class="err">&lt;</span>%= f.text_field :title, :placeholder =&gt; &#39;Title&#39;, :size =&gt; &#39;auto&#39; %&gt;
</span><span class='line'>  <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;text_field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= f.label :body %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= f.text_area :body, :placeholder =&gt; &#39;Body&#39; %&gt;<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>%= f.submit &quot;Save Page&quot;, :class =&gt; &quot;buttonize submit_form&quot;, :id =&gt; &#39;form_submitter&#39; %&gt;
</span><span class='line'>
</span><span class='line'><span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>show.html.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;text_field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;morning_page_title&quot;</span><span class="nt">&gt;</span>Title<span class="nt">&lt;/label&gt;</span>
</span><span class='line'>          <span class="nt">&lt;p&gt;</span><span class="err">&lt;</span>%= @message.title%&gt;<span class="nt">&lt;br/&gt;&lt;/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;text_field&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;morning_page_title&quot;</span><span class="nt">&gt;</span>Body<span class="nt">&lt;/label&gt;</span>
</span><span class='line'>      <span class="nt">&lt;p&gt;</span><span class="err">&lt;</span>%= @message.body %&gt;<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/li&gt;</span>
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s very hard to describe how to do something, how to build, that&#8217;s why probably will be better just to check source code or build by you own without copy/paste tutorials. I&#8217;m sure that many beginers and not only beginners stuck with ideas, they don&#8217;t want to build one more blog and this is idea not motivate to code and practice. When you really want to build something, that is the best period to practice and learn stuff, especially if you are doing this with somebody together. A lot of people looking for &#8220;weekend&#8221; project or to build something and hack with other, but the only place where they can find it is github. Github is good, but how to find in thousands project something simple and interesting for beginers? Will think about this, looks like an interesting idea.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-07T23:55:00-07:00" pubdate data-updated="true">May 7<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/bootstrap/'>bootstrap</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/tutorial/'>tutorial</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/30/eventmachine-and-websockets/">EventMachine and WebSockets</a></h1>
	<div class="entry-content">
		<p>Few days couldn&#8217;t use mt keyboard because fell of my bike and hurt my arms. Still using only one hand and that&#8217;s enough to start doing some epic code ;) Today I&#8217;m going to start exploring world of websockets when you can send data from server to client&#8217;s browser. Two things required - eventmachine as usual and em-websocket (<em>gem install em-websocket</em>)</p>

<p>The simplest echo server/client:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-websocket&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Server started on 127.0.0.1:4000 (open index.html in your browser)&quot;</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">::</span><span class="no">WebSocket</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">websocket</span><span class="o">|</span>
</span><span class='line'>    <span class="n">websocket</span><span class="o">.</span><span class="n">onopen</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Client connected&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">websocket</span><span class="o">.</span><span class="n">onmessage</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">p</span> <span class="n">msg</span>
</span><span class='line'>      <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;</span>
</span><span class='line'><span class="cp">   &quot;http://www.w3.org/TR/html4/strict.dtd&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>index<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">ws</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s2">&quot;WebSocket&quot;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Sorry, WebSockets unavailable.&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://127.0.0.1:4000/&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected...&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;hello server&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;hello again&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#echo&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;socket closed&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        meh
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;echo&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>websocket client side</h2>

<ul>
<li><strong>ws = new WebSocket(&#8220;ws://127.0.0.1:4000/&#8221;);</strong> create WebSocket object</li>
<li><strong>onopen</strong> - call it when a socket has opened</li>
<li><strong>onmessage</strong> - call it when a message has been received</li>
<li><strong>onclose</strong> - when a socket has been closed</li>
</ul>


<h2>websocket server side</h2>

<ul>
<li><strong>EM::WebSocket.start(:host => &#8216;127.0.0.1&#8217;, :port => 4000) do |websocket|</strong> open and listen requests on port 4000</li>
<li><strong>onopen</strong> - call it when a socket has opened</li>
<li><strong>onmessage</strong> - call it when a message has been received</li>
<li><strong>onclose</strong> - when a socket has been closed</li>
</ul>


<p>Let&#8217;s play a little bit with websocket and our last project that scans websites and gets <strong>header</strong> (I&#8217;m really n00b with frontend stuff, so, don&#8217;t judge me)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;</span>
</span><span class='line'><span class="cp">   &quot;http://www.w3.org/TR/html4/strict.dtd&quot;&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>index<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="na">content=</span><span class="s">&quot;Ruslan Khakimov&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&#39;http://127.0.0.1:3000/jquery-1.7.2.js&#39;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">ws</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="s2">&quot;WebSocket&quot;</span> <span class="k">in</span> <span class="nb">window</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Sorry, WebSockets unavailable.&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&quot;ws://127.0.0.1:8080/&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;connected...&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">nginx</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">nginx</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">apache</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">apache</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">ms</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ms</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">total</span> <span class="o">=</span> <span class="nx">nginx</span> <span class="o">+</span> <span class="nx">apache</span> <span class="o">+</span> <span class="nx">ms</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">render_star</span><span class="p">(</span><span class="s1">&#39;nginx&#39;</span><span class="p">,</span> <span class="nx">nginx</span><span class="o">/</span><span class="nx">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">render_star</span><span class="p">(</span><span class="s1">&#39;apache&#39;</span><span class="p">,</span> <span class="nx">apache</span><span class="o">/</span><span class="nx">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">render_star</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="nx">ms</span><span class="o">/</span><span class="nx">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;socket closed&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">function</span> <span class="nx">render_star</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">num</span><span class="p">){</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span> <span class="nx">num</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span> <span class="nx">name</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;test&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    nginx: <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;nginx&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>    apache: <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;apache&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>    ms: <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;ms&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and server:</p>

<figure class='code'><figcaption><span>server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;em-websocket&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;json&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">EventMachine</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">DNS</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Request</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@socket</span> <span class="o">=</span> <span class="n">socket</span>
</span><span class='line'>        <span class="vi">@hostname</span> <span class="o">=</span> <span class="n">hostname</span>
</span><span class='line'>        <span class="vi">@tries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="vi">@last_send</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@retry_interval</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>        <span class="vi">@max_tries</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">addrs</span> <span class="o">=</span> <span class="no">Resolver</span><span class="o">.</span><span class="n">hosts</span><span class="o">[</span><span class="n">hostname</span><span class="o">]</span>
</span><span class='line'>          <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;domain&quot;</span><span class="o">=&gt;</span> <span class="vi">@hostname</span><span class="p">,</span> <span class="s2">&quot;ips&quot;</span> <span class="o">=&gt;</span> <span class="n">addrs</span><span class="p">}</span>
</span><span class='line'>          <span class="n">succeed</span> <span class="n">info</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span> <span class="p">{</span> <span class="n">tick</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">receive_answer</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>        <span class="n">addrs</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="n">each_answer</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span><span class="n">ttl</span><span class="p">,</span><span class="n">data</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="n">A</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">data</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="no">AAAA</span><span class="p">)</span>
</span><span class='line'>            <span class="n">addrs</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">addrs</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>          <span class="nb">fail</span> <span class="s2">&quot;rcode=</span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">rcode</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="vi">@hostname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;domain&quot;</span><span class="o">=&gt;</span> <span class="vi">@hostname</span><span class="p">,</span> <span class="s2">&quot;ips&quot;</span> <span class="o">=&gt;</span> <span class="n">addrs</span><span class="p">}</span>
</span><span class='line'>          <span class="n">succeed</span> <span class="n">info</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;1.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">EM</span><span class="o">::</span><span class="no">Connection</span>
</span><span class='line'>  <span class="vc">@@webserver_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;nginx&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;apache&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">domain</span><span class="p">,</span> <span class="n">channel</span>
</span><span class='line'>    <span class="vi">@domain</span> <span class="o">=</span> <span class="n">domain</span>
</span><span class='line'>    <span class="n">comm_inactivity_timeout</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>    <span class="n">pending_connect_timeout</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class='line'>    <span class="vi">@channel</span> <span class="o">=</span> <span class="n">channel</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">Host: </span><span class="si">#{</span><span class="vi">@domain</span><span class="si">}</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Parse answer from webserver and count stats </span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=~</span> <span class="sr">/Server: ([^\r\n]*)/</span>
</span><span class='line'>    <span class="n">webserver</span> <span class="o">=</span> <span class="vg">$1</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">webserver</span>
</span><span class='line'>    <span class="k">when</span><span class="sr"> /nginx/</span>      <span class="k">then</span>  <span class="vc">@@webserver_stats</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s2">&quot;nginx&quot;</span> <span class="o">=&gt;</span> <span class="vc">@@webserver_stats</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">})</span>
</span><span class='line'>    <span class="k">when</span><span class="sr"> /Apache/</span>     <span class="k">then</span>  <span class="vc">@@webserver_stats</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s2">&quot;apache&quot;</span> <span class="o">=&gt;</span> <span class="vc">@@webserver_stats</span><span class="o">[</span><span class="s1">&#39;apache&#39;</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">})</span>
</span><span class='line'>    <span class="k">when</span><span class="sr"> /Microsoft/</span>  <span class="k">then</span>  <span class="vc">@@webserver_stats</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="s2">&quot;ms&quot;</span> <span class="o">=&gt;</span> <span class="vc">@@webserver_stats</span><span class="o">[</span><span class="s1">&#39;ms&#39;</span><span class="o">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">})</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">p</span> <span class="n">webserver</span>
</span><span class='line'>    <span class="vi">@channel</span><span class="o">.</span><span class="n">push</span> <span class="vc">@@webserver_stats</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close_connection</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">total_connection</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="n">urls_size</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@channel</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">Channel</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">connect</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">300</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>      <span class="n">dns</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resolver</span><span class="o">.</span><span class="n">resolve</span> <span class="n">url</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dns</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span><span class="o">|</span><span class="n">data</span><span class="o">|</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">connect</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;ips&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="no">Client</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;domain&quot;</span><span class="o">]</span><span class="p">,</span> <span class="vi">@channel</span> <span class="k">unless</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;ips&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">].</span><span class="n">nil?</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dns</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span> <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">total_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">total_connection</span> <span class="o">&lt;</span> <span class="n">urls_size</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span> <span class="p">}</span>  <span class="c1">#originaly here should be something like 0.002, but this is test</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span><span class="no">EM</span><span class="o">.</span><span class="n">stop</span><span class="p">}</span>   <span class="c1"># 5 seconds timer to lets finish slow connections</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># print stats with progress every 3 seconds</span>
</span><span class='line'>  <span class="n">stats</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;current connection: </span><span class="si">#{</span><span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span><span class="si">}</span><span class="s2">, total: </span><span class="si">#{</span><span class="n">total_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2">\</span>
</span><span class='line'><span class="s2">        successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures, </span><span class="si">#{</span> <span class="p">(</span><span class="n">successes</span> <span class="o">/</span> <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span><span class="o">.</span><span class="n">to_i</span><span class="si">}</span><span class="s2"> domains/sec&quot;</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># starts websocket server</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">::</span><span class="no">WebSocket</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="mi">8080</span><span class="p">,</span> <span class="ss">:debug</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ws</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ws</span><span class="o">.</span><span class="n">onopen</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sid</span> <span class="o">=</span> <span class="vi">@channel</span><span class="o">.</span><span class="n">subscribe</span> <span class="p">{</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ws</span><span class="o">.</span><span class="n">onclose</span> <span class="p">{</span>
</span><span class='line'>      <span class="vi">@channel</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="nb">p</span> <span class="s2">&quot;Total </span><span class="si">#{</span><span class="n">total_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures in </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8230;few days of repairing after bike crash&#8230;</p>

<p>Thats how simple using websockets is, and combined with eventmachine, they can be pretty awesome together. This is the end of my journey with EM for this time and I&#8217;m going to improve some skills with Rails. Let me know on email ruslan@&lt;%= current_domain_name %> if you have any question about eventmachine.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-30T18:46:00-07:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/eventmachine/'>eventmachine</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/websocket/'>websocket</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/27/data-structure/">Data Structure</a></h1>
	<div class="entry-content">
		<p>Repeat/learn TODO. <a href="http://en.wikipedia.org/wiki/Data_structure">Data structure</a></p>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Array_data_structure">Array</a></li>
<li><a href="http://en.wikipedia.org/wiki/Hash_table">Hash table</a></li>
<li><a href="http://en.wikipedia.org/wiki/Set_(abstract_data_type)">Set (abstract data type)</a></li>
<li><a href="http://en.wikipedia.org/wiki/Linked_list">Linked list</a></li>
<li><a href="http://en.wikipedia.org/wiki/Stack_(abstract_data_type)">Stack (abstract data type)</a></li>
<li><a href="http://en.wikipedia.org/wiki/Queue_(abstract_data_type)">Queue (abstract data type)</a></li>
<li><a href="http://en.wikipedia.org/wiki/Graph_(mathematics)">Graph (mathematics)</a></li>
<li><a href="http://en.wikipedia.org/wiki/Binary_search_tree">Binary search tree</a></li>
<li><a href="http://en.wikipedia.org/wiki/AVL_tree">AVL tree</a></li>
<li><a href="http://en.wikipedia.org/wiki/B-tree">B-tree</a></li>
<li><a href="http://en.wikipedia.org/wiki/Suffix_tree">Suffix tree</a></li>
<li><a href="http://en.wikipedia.org/wiki/Binary_search_algorithm">Binary search algorithm</a></li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-27T23:20:00-07:00" pubdate data-updated="true">Apr 27<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/cs/'>cs</a>, <a class='category' href='/blog/categories/data/'>data</a>, <a class='category' href='/blog/categories/structure/'>structure</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/25/eventmachine-day-5/">EventMachine. Day 5</a></h1>
	<div class="entry-content">
		<p>Day 5 and I hope today I&#8217;m going solve this quest with EventMachine. The main idea I&#8217;ve got from this - never give up, don’t give up on becoming a programmer.</p>

<p>Yesterday I had a conversation on IRC with <a href="http://github.com/raggi">raggi</a> (today I realized that he is a one of the main EventMachine contributor ;)</p>

<figure class='code'><figcaption><span>&#8220;freenode.net irc #eventmachine channel&#8221;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">58</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="n">you</span><span class="err">&#39;</span><span class="n">ll</span> <span class="n">get</span> <span class="o">**</span><span class="n">blocked</span> <span class="n">by</span> <span class="n">domain</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">slow</span> <span class="n">down</span> <span class="n">connect</span> <span class="n">rate</span><span class="o">**</span>
</span><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="ow">and</span> <span class="n">many</span> <span class="n">servers</span> <span class="n">will</span> <span class="n">also</span> <span class="n">limit</span> <span class="n">a</span> <span class="n">single</span> <span class="n">ip</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">a</span> <span class="n">max</span> <span class="n">number</span> <span class="n">of</span> <span class="n">times</span>
</span><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">21</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="n">so</span> <span class="n">there</span> <span class="n">are</span> <span class="n">a</span> <span class="n">bunch</span> <span class="n">of</span> <span class="n">potential</span> <span class="n">reasons</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">19</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="n">em</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">request</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">very</span> <span class="n">good</span> <span class="k">for</span> <span class="n">crawling</span>
</span><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="n">i</span> <span class="n">wrote</span> <span class="n">a</span> <span class="n">commercial</span> <span class="n">crawler</span> <span class="n">on</span> <span class="n">top</span> <span class="n">of</span> <span class="n">it</span><span class="p">,</span> <span class="ow">and</span> <span class="n">had</span> <span class="n">to</span> <span class="n">hack</span> <span class="n">out</span> <span class="n">a</span> <span class="n">lot</span> <span class="n">of</span> <span class="n">shit</span> <span class="n">to</span> <span class="n">make</span> <span class="n">it</span> <span class="n">move</span>
</span><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">41</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="n">it</span> <span class="n">will</span> <span class="n">now</span> <span class="n">fill</span> <span class="n">a</span> <span class="mi">100</span><span class="n">mb</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">though</span>
</span><span class='line'><span class="o">[</span><span class="mi">23</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">17</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">raggi</span><span class="o">&gt;</span> <span class="n">lots</span> <span class="n">of</span> <span class="n">other</span> <span class="n">standard</span> <span class="n">crawler</span> <span class="n">tricks</span> <span class="n">though</span><span class="p">,</span> <span class="n">dynamic</span> <span class="n">resource</span> <span class="n">reallocation</span><span class="p">,</span> <span class="n">dns</span> <span class="n">rotation</span> <span class="n">tracking</span><span class="p">,</span> <span class="n">etc</span>
</span></code></pre></td></tr></table></div></figure>


<p>BOOM! Blocked by DNS! BOOM twice! That&#8217;s why I got a problem when using domains names and didn&#8217;t have any problems with direct ip request. I wrote this script and just tested with dns request:</p>

<figure class='code'><figcaption><span>dns.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;100k.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">count_connection</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="n">urls_size</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">connect</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">current_connection</span> <span class="o">&lt;</span> <span class="mi">200</span>
</span><span class='line'>      <span class="n">domain</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>      <span class="n">dns</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resolver</span><span class="o">.</span><span class="n">resolve</span> <span class="n">domain</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dns</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">current_connection</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dns</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">current_connection</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">count_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">current_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">count_connection</span> <span class="o">&gt;</span> <span class="n">urls_size</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">count_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="n">stats</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;total: </span><span class="si">#{</span><span class="n">count_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures&quot;</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="s2">&quot;Total </span><span class="si">#{</span><span class="n">count_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures in </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><figcaption><span>puts every 5 seconds with stats</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">○</span> <span class="n">ruby</span> <span class="n">client3</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="s2">&quot;total: 2062, 1768 successful, 93 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;total: 3193, 2835 successful, 157 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;total: 4040, 3621 successful, 218 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;total: 5165, 4698 successful, 266 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;total: 6010, 5502 successful, 307 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;total: 7123, 6557 successful, 365 failures&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8220;Total 100001, 94569 successful, 5231 failures in 494.766191s&#8221; if I just use EM::Interator.new it will be faster, but much more failures, because probably dns servers reject many connection from the same IP address, I&#8217;m not sure, but it sounds logical (otherwise we can run this script from 100 boxes with 10k connection in the same time and dns should be response to 1mln request, it&#8217;s kind of ddos, isn&#8217;t). Btw about ddos, yesterday when I tested server/client I didn&#8217;t use any limitation and today got this <em>the node PM14 is being rebooted just now. A ddos attack caused a kernel panic on the network stack.</em> =)</p>

<p>/sleep/</p>

<p>Good morning, yesterday I went to sleep with a smile on my face. Yes, I did it, I got shit out of my connection, but after workout didn&#8217;t have strength to finish this post. This morning I started with <a href="http://en.wikipedia.org/wiki/Monkey_patch">monkey patching</a> because EventMachine Resolver returns only addrs (ips), but I also needed hostnames. This is my first monkey patch I&#8217;ve done. Original  <a href="https://github.com/eventmachine/eventmachine/blob/master/lib/em/resolver.rb">code</a>:</p>

<figure class='code'><figcaption><span>monkey patch</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">EventMachine</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">DNS</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Request</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@socket</span> <span class="o">=</span> <span class="n">socket</span>
</span><span class='line'>        <span class="vi">@hostname</span> <span class="o">=</span> <span class="n">hostname</span>
</span><span class='line'>        <span class="vi">@tries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="vi">@last_send</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@retry_interval</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>        <span class="vi">@max_tries</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">addrs</span> <span class="o">=</span> <span class="no">Resolver</span><span class="o">.</span><span class="n">hosts</span><span class="o">[</span><span class="n">hostname</span><span class="o">]</span>
</span><span class='line'>          <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;domain&quot;</span><span class="o">=&gt;</span> <span class="vi">@hostname</span><span class="p">,</span> <span class="s2">&quot;ips&quot;</span> <span class="o">=&gt;</span> <span class="n">addrs</span><span class="p">}</span> <span class="c1"># just added this string</span>
</span><span class='line'>          <span class="n">succeed</span> <span class="n">info</span>                                  <span class="c1"># to return hash</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span> <span class="p">{</span> <span class="n">tick</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">receive_answer</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>        <span class="n">addrs</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="n">each_answer</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span><span class="n">ttl</span><span class="p">,</span><span class="n">data</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="n">A</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">data</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="no">AAAA</span><span class="p">)</span>
</span><span class='line'>            <span class="n">addrs</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">addrs</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>          <span class="nb">fail</span> <span class="s2">&quot;rcode=</span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">rcode</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;domain&quot;</span><span class="o">=&gt;</span> <span class="vi">@hostname</span><span class="p">,</span> <span class="s2">&quot;ips&quot;</span> <span class="o">=&gt;</span> <span class="n">addrs</span><span class="p">}</span> <span class="c1"># same thing</span>
</span><span class='line'>          <span class="n">succeed</span> <span class="n">info</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Btw, two things I&#8217;ve realized. I have to repeat fundamental about <a href="http://www.ruby-doc.org/core-1.9.3/Hash.html">Hash</a> and <a href="http://www.ruby-doc.org/core-1.9.3/Regexp.html">Regexp</a>.</p>

<p>I got this result and you probably think I&#8217;m happy now. No, not at all. Now count_connection based on DNS requests, when I need count_connection for HTTP connection. To solve it I have to communicate with class Client and count connection there.</p>

<p><img src="http://pix.am/PfIT.png" alt="eventmachine in action" /></p>

<p>As we know class variables is shared among all objects of a class, if you forget - class variables start with two &#8220;at&#8221; signs, such as @@connections. So if we want to count how many current connection, we have to use class variables, something like this:</p>

<figure class='code'><figcaption><span>class variables</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Client</span>
</span><span class='line'>
</span><span class='line'>  <span class="vc">@@connections</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add</span>
</span><span class='line'>    <span class="vc">@@connections</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">connections</span>
</span><span class='line'>    <span class="vc">@@connections</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="mi">10</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">add</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="no">Client</span><span class="o">.</span><span class="n">connections</span> <span class="c1"># =&gt; 10</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next thing we have to parse the answers from the website. I&#8217;m looking for header and information about Server. Regular expressions always were pain in ass for me that&#8217;s why I&#8217;m sitting right now with a book &#8220;Progmatic Programmer&#8217;s Guide&#8221; on the page number 76 and reading about Object-Oriented Regular Expressions.</p>

<p>In out class Client we receive and process data in method <strong>receive_data</strong>, here we can write our regexp which will find information that we are looking for:</p>

<figure class='code'><figcaption><span>class variables</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=~</span> <span class="sr">/Server: ([^\n$]*)$/</span>
</span><span class='line'>  <span class="n">server_name</span> <span class="o">=</span> <span class="vg">$1</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">close_connection_after_writing</span>
</span><span class='line'>  <span class="vc">@@connections</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As I read today this <a href="http://japhr.blogspot.com/2012/04/366-or-how-i-tricked-myself-into-being.html">post</a> the author says</p>

<blockquote><p>I knew nothing about them before I started writing them.</p></blockquote>

<p>Let&#8217;s just write a little bit about regexp by my words and hope it will help me and you to undersand better how it works. This is all my thoughts and I maybe wrong, let me know if I&#8217;m wrong with any definition. Regular expression (regexp) are used to find patterns in a string. Few ways to create regexp:</p>

<figure class='code'><figcaption><span>class variables</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">test_regexp</span> <span class="o">=</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;^\w+&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="sr">/^\w+/</span>
</span><span class='line'><span class="n">test_regexp2</span> <span class="o">=</span> <span class="sr">/^w+/</span>             <span class="o">-&gt;</span> <span class="sr">/^\w+/</span>
</span><span class='line'><span class="n">test_regexp3</span> <span class="o">=</span> <span class="sr">%r{^\w+}</span>          <span class="o">-&gt;</span> <span class="sr">/^\w+/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Probably that was not a good idea to explaine how regexp works, but in few words you have to remember this table:</p>

<figure class='code'><figcaption><span>class variables</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">\</span><span class="n">d</span>      <span class="o">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="o">]</span>                   <span class="no">Digit</span> <span class="n">character</span>
</span><span class='line'><span class="p">\</span><span class="n">D</span>      <span class="o">[^</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="o">]</span>                  <span class="no">Any</span> <span class="n">character</span> <span class="n">except</span> <span class="n">a</span> <span class="n">digit</span>
</span><span class='line'><span class="p">\</span><span class="n">s</span>      <span class="o">[</span><span class="p">\</span><span class="n">s</span><span class="p">\</span><span class="n">t</span><span class="p">\</span><span class="n">r</span><span class="p">\</span><span class="n">n</span><span class="p">\</span><span class="n">f</span><span class="o">]</span>            <span class="no">Whitespace</span> <span class="n">character</span>
</span><span class='line'><span class="p">\</span><span class="n">S</span>      <span class="o">[^</span><span class="p">\</span><span class="n">s</span><span class="p">\</span><span class="n">t</span><span class="p">\</span><span class="n">r</span><span class="p">\</span><span class="n">n</span><span class="p">\</span><span class="n">f</span><span class="o">]</span>           <span class="no">Any</span> <span class="n">except</span> <span class="n">whitespace</span>
</span><span class='line'><span class="p">\</span><span class="n">w</span>      <span class="o">[</span><span class="n">A</span><span class="o">-</span><span class="no">Za</span><span class="o">-</span><span class="n">z0</span><span class="o">-</span><span class="mi">9</span><span class="n">_</span><span class="o">]</span>            <span class="no">Word</span> <span class="n">character</span>
</span><span class='line'><span class="p">\</span><span class="n">W</span>      <span class="o">[^</span><span class="n">A</span><span class="o">-</span><span class="no">Za</span><span class="o">-</span><span class="n">z0</span><span class="o">-</span><span class="mi">9</span><span class="n">_</span><span class="o">]</span>           <span class="no">Any</span> <span class="n">except</span> <span class="n">a</span> <span class="n">word</span> <span class="n">character</span>
</span></code></pre></td></tr></table></div></figure>


<p>How to use?</p>

<figure class='code'><figcaption><span>regexp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">re</span> <span class="o">=</span> <span class="sr">/(\d+):(\d+)/</span>                      <span class="c1"># match time hh:mm \d means any digit character. + means match one or more</span>
</span><span class='line'><span class="n">time</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;Time is: 11:22am&quot;</span><span class="p">)</span>     <span class="c1"># time now is MatchData</span>
</span><span class='line'><span class="n">time</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>                                 <span class="c1"># =&gt; &quot;11:22&quot;</span>
</span><span class='line'><span class="n">time</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>                                 <span class="c1"># =&gt; &quot;11&quot;</span>
</span><span class='line'><span class="n">time</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>                                 <span class="c1"># =&gt; &quot;22&quot;</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">pre_match</span>                          <span class="c1"># =&gt; &quot;Time is: &quot;</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">post_match</span>                         <span class="c1"># =&gt; &quot;am&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For example we have header like this</p>

<p>HTTP/1.1 200 OK
Content-Type: text/html;charset=utf-8
Last-Modified: Fri, 27 Apr 2012 00:39:33 GMT
Content-Length: 141332
Server: WEBrick/1.3.1 (Ruby/1.9.2/2011-07-09)
Date: Fri, 27 Apr 2012 00:41:48 GMT
Connection: Keep-Alive</p>

<p>and we need to get only name of the server. It&#8217;s easy <strong>header =~ /Server: ([<sup>\n$]*)$/**</sup> and </strong>$1<strong> will show </strong>&#8220;WEBrick/1.3.1 (Ruby/1.9.2/2011-07-09)&#8221;**. Version 1.0 here, just does 1 mln request to <a href="http://s3.amazonaws.com/alexa-static/top-1m.csv.zip">1 mln websites</a> and gets Server names, uhh:</p>

<figure class='code'><figcaption><span>regexp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Apache/2.2.11 (Unix) DAV/2&quot;</span>
</span><span class='line'><span class="s2">&quot;Apache&quot;</span>
</span><span class='line'><span class="s2">&quot;nginx/1.0.2&quot;</span>
</span><span class='line'><span class="s2">&quot;nginx/0.7.69&quot;</span>
</span><span class='line'><span class="s2">&quot;Microsoft-IIS/6.0&quot;</span>
</span><span class='line'><span class="s2">&quot;Microsoft-IIS/6.0&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 15, total: 1000, 968        successful, 31 failures, 161 domains/sec&quot;</span>
</span><span class='line'><span class="s2">&quot;Total 1000, 968 successful, 32 failures in 7.456237s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby code here (I&#8217;ve removed @@class instance, because EM::connection_count() is enough):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">EventMachine</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">DNS</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Request</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@socket</span> <span class="o">=</span> <span class="n">socket</span>
</span><span class='line'>        <span class="vi">@hostname</span> <span class="o">=</span> <span class="n">hostname</span>
</span><span class='line'>        <span class="vi">@tries</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="vi">@last_send</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@retry_interval</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>        <span class="vi">@max_tries</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">addrs</span> <span class="o">=</span> <span class="no">Resolver</span><span class="o">.</span><span class="n">hosts</span><span class="o">[</span><span class="n">hostname</span><span class="o">]</span>
</span><span class='line'>          <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;domain&quot;</span><span class="o">=&gt;</span> <span class="vi">@hostname</span><span class="p">,</span> <span class="s2">&quot;ips&quot;</span> <span class="o">=&gt;</span> <span class="n">addrs</span><span class="p">}</span>
</span><span class='line'>          <span class="n">succeed</span> <span class="n">info</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span> <span class="p">{</span> <span class="n">tick</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">receive_answer</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>        <span class="n">addrs</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="n">each_answer</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span><span class="n">ttl</span><span class="p">,</span><span class="n">data</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="n">A</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">data</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="no">AAAA</span><span class="p">)</span>
</span><span class='line'>            <span class="n">addrs</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">addrs</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>          <span class="nb">fail</span> <span class="s2">&quot;rcode=</span><span class="si">#{</span><span class="n">msg</span><span class="o">.</span><span class="n">rcode</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="vi">@hostname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;domain&quot;</span><span class="o">=&gt;</span> <span class="vi">@hostname</span><span class="p">,</span> <span class="s2">&quot;ips&quot;</span> <span class="o">=&gt;</span> <span class="n">addrs</span><span class="p">}</span>
</span><span class='line'>          <span class="n">succeed</span> <span class="n">info</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;100k.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">EM</span><span class="o">::</span><span class="no">Connection</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">domain</span>
</span><span class='line'>    <span class="vi">@domain</span> <span class="o">=</span> <span class="n">domain</span>
</span><span class='line'>    <span class="n">comm_inactivity_timeout</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'>    <span class="n">pending_connect_timeout</span> <span class="o">=</span> <span class="mi">5</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">Host: </span><span class="si">#{</span><span class="vi">@domain</span><span class="si">}</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=~</span> <span class="sr">/Server: ([^\r\n]*)/</span>
</span><span class='line'>    <span class="nb">p</span> <span class="vg">$1</span>
</span><span class='line'>    <span class="n">close_connection</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">total_connection</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="n">urls_size</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">connect</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">300</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">pop</span>
</span><span class='line'>      <span class="n">dns</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resolver</span><span class="o">.</span><span class="n">resolve</span> <span class="n">url</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dns</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span><span class="o">|</span><span class="n">data</span><span class="o">|</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">connect</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;ips&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="no">Client</span><span class="p">,</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;domain&quot;</span><span class="o">]</span> <span class="k">unless</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;ips&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">].</span><span class="n">nil?</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">dns</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span> <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">total_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">total_connection</span> <span class="o">&lt;</span> <span class="n">urls_size</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">002</span><span class="p">)</span> <span class="p">{</span> <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span><span class="no">EM</span><span class="o">.</span><span class="n">stop</span><span class="p">}</span>   <span class="c1"># 5 seconds timer to lets finish slow connections</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># print stats with progress every 3 seconds</span>
</span><span class='line'>  <span class="n">stats</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;current connection: </span><span class="si">#{</span><span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span><span class="si">}</span><span class="s2">, total: </span><span class="si">#{</span><span class="n">total_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2">\</span>
</span><span class='line'><span class="s2">        successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures, </span><span class="si">#{</span> <span class="p">(</span><span class="n">successes</span> <span class="o">/</span> <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span><span class="o">.</span><span class="n">to_i</span><span class="si">}</span><span class="s2"> domains/sec&quot;</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="nb">p</span> <span class="s2">&quot;Total </span><span class="si">#{</span><span class="n">total_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures in </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>TODO: Redis, Rails, Websocket. Good night, was a wonderful week!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-25T13:59:00-07:00" pubdate data-updated="true">Apr 25<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/24/eventmachine-day-4/">EventMachine. Day 4</a></h1>
	<div class="entry-content">
		<p>I&#8217;m at MiniService for regular routine, drinking coffee and reading this article <a href="http://ninjasandrobots.com/you-need-some-experience">I have no idea what I&#8217;m doing</a> and after I read it the only one I wanna say <em>I&#8217;ll figure this out. And you will too =)</em>. Let&#8217;s start!</p>

<p>Yesterday we stoped at <em>EM::Iterator.new(0..100, 50).each</em> and realized if we change it to <em>EM::Iterator.new(0..100000, 50).each</em> then it doesn&#8217;t work well, probably generate thousand request in the same time and overflow the network.</p>

<p>I rewrite client.rb and now it looks better I think (tested on localhost):</p>

<figure class='code'><figcaption><span>client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-http&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># File.open(&quot;1.csv&quot;, &#39;r&#39;) do |f|</span>
</span><span class='line'><span class="c1">#   while(line = f.gets)</span>
</span><span class='line'><span class="c1">#     urls &lt;&lt; &quot;http://&quot; + line.split(&quot;,&quot;)[1].strip</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1"># end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">kqueue</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">count_connection</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">total_connection</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
</span><span class='line'>  <span class="n">connect</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">count_connection</span> <span class="o">&lt;</span> <span class="mi">50</span>
</span><span class='line'>      <span class="c1"># url = urls.pop</span>
</span><span class='line'>      <span class="n">http</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="ss">:connect_timeout</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:inactivity_timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">p</span> <span class="s2">&quot;current connection: </span><span class="si">#{</span><span class="n">count_connection</span><span class="si">}</span><span class="s2"> vs </span><span class="si">#{</span><span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span><span class="si">}</span><span class="s2">, total: </span><span class="si">#{</span><span class="n">total_connection</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">count_connection</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">count_connection</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">total_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">count_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">total_connection</span> <span class="o">&gt;</span> <span class="mi">10000</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">count_connection</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>
</span><span class='line'><span class="nb">p</span> <span class="s2">&quot;Total </span><span class="si">#{</span><span class="n">total_connection</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures in </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m using callback and recursion, so when I get http.callback program start next connection until I get current_connection &lt; 50.</p>

<figure class='code'><figcaption><span>client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;current connection: 5 vs 7, total: 9996&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 5 vs 7, total: 9997&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 5 vs 7, total: 9998&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 5 vs 7, total: 9999&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 5 vs 7, total: 10000&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 5 vs 7, total: 10001&quot;</span>
</span><span class='line'><span class="s2">&quot;Total 10001, 9996 successful, 4 failures in 5.736506s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sounds good, I&#8217;ve installed nginx on remote server in internet (just change url = &#8220;http://127.0.0.1&#8221; to url = &#8220;http://webserver&#8221;) and as a test ran with 100 connections. And got a nice picture <strong>&#8220;Total 10001, 9872 successful, 128 failures in 113.439425s&#8221;</strong> and this is not the end, look at the network monitor:</p>

<p><img src="http://pix.am/C1kb.png" alt="" /></p>

<p>Yes! I used full network channel to get responses from my server. Looks like the end of the story, isn&#8217;t? Stop, let&#8217;s test it with our 1_000_000 webservers. Got this and don&#8217;t know why yet:</p>

<figure class='code'><figcaption><span>client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;current connection: 9 vs 11, total: 176, 158 successful, 8 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 9 vs 11, total: 177, 159 successful, 8 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 8 vs 11, total: 178, 161 successful, 8 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 9 vs 10, total: 179, 161 successful, 8 failures&quot;</span>
</span><span class='line'><span class="s2">&quot;current connection: 10 vs 11, total: 180, 161 successful, 8 failures&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Looks like it works only with 10 connection in the same time and don&#8217;t increase it, why is it possible I don&#8217;t know yet. The only one idea about dns resolver. I&#8217;m going to read and will back to fight tomorrow!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-24T10:44:00-07:00" pubdate data-updated="true">Apr 24<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/eventmachine/'>eventmachine</a>, <a class='category' href='/blog/categories/network/'>network</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/23/eventmachine-day-3/">EventMachine. Day 3</a></h1>
	<div class="entry-content">
		<p>Just bought large coffee from Coupa cafe and ready for the next fight. Today I read few article and checked few github repositories with eventmachine examples.</p>

<p><a href="http://blog.nominet.org.uk/tech/2007/10/12/dnsruby-and-eventmachine/">Dnsruby and EventMachine</a></p>

<p>So, now I&#8217;m reading about <a href="http://eventmachine.rubyforge.org/docs/DEFERRABLES.html">Deferrables</a> and the only one thing I&#8217;m gonna share with you - <em>You may need to read the following material through more than once before you get the idea.</em> =)</p>

<blockquote><p>The Deferrable pattern allows you to specify any number of Ruby code blocks (callbacks or errbacks) that will be executed at some future time when the status of the Deferrable object changes. How might that be useful? Well, imagine that you’re implementing an HTTP server, but you need to make a call to some other server in order to fulfill a client request.</p></blockquote>

<p>When you&#8217;ll read it you&#8217;ll realize that we&#8217;ve already used EM::Deferrable. For example when we are using EM::Protocols::HttpClient#request it returns a Deferrable object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">df</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">Protocols</span><span class="o">::</span><span class="no">HttpClient</span><span class="o">.</span><span class="n">request</span><span class="p">(</span> <span class="ss">:host</span><span class="o">=&gt;</span><span class="s2">&quot;www.example.com&quot;</span><span class="p">,</span> <span class="ss">:request</span><span class="o">=&gt;</span><span class="s2">&quot;/index.html&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">df</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span><span class="o">|</span><span class="n">response</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Succeeded: </span><span class="si">#{</span><span class="n">response</span><span class="o">[</span><span class="ss">:content</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">stop</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">df</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span><span class="o">|</span><span class="n">response</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;ERROR: </span><span class="si">#{</span><span class="n">response</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">stop</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It works, but still speed is not good as I&#8217;m looking for. My idea is creating a pool with 200 connections in the same time and recursively adding new connection each time when old connection finished. Some specs here:</p>

<ul>
<li>200 connections in the same time always</li>
<li>connection timeout = 3 seconds</li>
<li>connection innactive = 5 seconds</li>
</ul>


<p><img src="http://pix.am/HTuTl.png" alt="" /></p>

<p>Because I don&#8217;t have internet connection in the library I&#8217;m going build server with random timeout response between 1-3 seconds. Let&#8217;s do it with eventmachine ;)</p>

<figure class='code'><figcaption><span>server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="no">EventMachine</span><span class="o">::</span><span class="no">Connection</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">p</span> <span class="no">EM</span><span class="o">.</span><span class="n">connection_count</span>
</span><span class='line'>    <span class="nb">sleep</span><span class="p">(</span><span class="nb">rand</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;200&quot;</span>
</span><span class='line'>    <span class="n">close_connection_after_writing</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">::</span><span class="n">start_server</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="no">Server</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">EM</span><span class="o">::</span><span class="no">Connection</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">num</span><span class="p">,</span> <span class="n">started_at</span>
</span><span class='line'>    <span class="vi">@num</span> <span class="o">=</span> <span class="n">num</span>
</span><span class='line'>    <span class="vi">@started_at</span> <span class="o">=</span> <span class="n">started_at</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>      <span class="n">send_data</span> <span class="s2">&quot;hi</span><span class="se">\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="nb">p</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@num</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="vi">@started_at</span><span class="si">}</span><span class="s2">- </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">close_connection</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">::</span><span class="no">Iterator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">num</span><span class="p">,</span> <span class="n">iter</span><span class="o">|</span>
</span><span class='line'>    <span class="no">EM</span><span class="o">.</span><span class="n">connect</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="no">Client</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span class='line'>    <span class="n">iter</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>2 hours break and here I am, though a little bit more and here is new version of previous awful code:</p>

<figure class='code'><figcaption><span>server.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">EM</span><span class="o">::</span><span class="n">start_server</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="mi">8000</span> <span class="k">do</span> <span class="o">|</span><span class="n">serv</span><span class="o">|</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">serv</span><span class="o">.</span><span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="nb">rand</span><span class="p">()</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">send_data</span> <span class="s2">&quot;200&quot;</span>
</span><span class='line'>          <span class="n">close_connection_after_writing</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="no">EM</span><span class="o">.</span><span class="n">connection_count</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">EM</span><span class="o">::</span><span class="no">Connection</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span> <span class="n">num</span><span class="p">,</span> <span class="n">started_at</span>
</span><span class='line'>    <span class="vi">@num</span> <span class="o">=</span> <span class="n">num</span>
</span><span class='line'>    <span class="vi">@started_at</span> <span class="o">=</span> <span class="n">started_at</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>      <span class="n">send_data</span> <span class="s2">&quot;ping&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="nb">p</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@num</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="vi">@started_at</span><span class="si">}</span><span class="s2">- </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">close_connection</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">::</span><span class="no">Iterator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">num</span><span class="p">,</span> <span class="n">iter</span><span class="o">|</span>
</span><span class='line'>    <span class="no">EM</span><span class="o">.</span><span class="n">connect</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="no">Client</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span class='line'>    <span class="n">iter</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>because in prev version of server.rb I&#8217;ve used sleep, that was a problem for reactor (EM) and it blocked the process. So, now results looks better:</p>

<figure class='code'><figcaption><span>client.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby</span> <span class="n">client</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="s2">&quot;31 - 3.348352- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;62 - 3.571507- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;91 - 3.582121- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;29 - 3.602537- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;92 - 3.59524- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;1 - 3.671826- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;35 - 3.686029- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;80 - 3.776847- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;63 - 3.800448- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;43 - 3.856598- 200&quot;</span>
</span><span class='line'><span class="s2">&quot;30 - 3.906939- 200&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>BUT if you write EM::Iterator.new(0..10000, 50).each it will be frozen for 10-20 seconds and only then you will get a result. Day 3 and again fail. But tomorrow is going be more interesting, because the truth is out there&#8230;</p>

<p>To read:</p>

<p><a href="http://nutrun.com/weblog/2008/05/04/distributed-programming-with-jabber-and-eventmachine.html">Distributed programming with Jabber and EventMachine</a>
<a href="http://blog.nominet.org.uk/tech/2007/10/12/dnsruby-and-eventmachine/">Dnsruby and EventMachine</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-23T12:41:00-07:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/concurrency/'>concurrency</a>, <a class='category' href='/blog/categories/crawl/'>crawl</a>, <a class='category' href='/blog/categories/eventmachine/'>eventmachine</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/21/eventmachine-and-web-crawler/">EventMachine and Web Crawler</a></h1>
	<div class="entry-content">
		<p>When I came back at home yesterday and tested the code on real data I realized that wasn&#8217;t work well. 1000 urls was ok, but 1_000_000 wasn&#8217;t, EM didn&#8217;t callback anything.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;1.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>    <span class="c1">#urls &lt;&lt; &quot;http://127.0.0.1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">p</span> <span class="n">urls</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">DumbHttpClient</span>
</span><span class='line'>   <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>     <span class="n">send_data</span> <span class="s2">&quot;GET / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">Host: _</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
</span><span class='line'>     <span class="vi">@data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>     <span class="vi">@parsed</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>     <span class="vi">@data</span> <span class="o">&lt;&lt;</span> <span class="n">data</span>
</span><span class='line'>     <span class="k">if</span> <span class="o">!</span><span class="vi">@parsed</span> <span class="ow">and</span> <span class="vi">@data</span> <span class="o">=~</span> <span class="sr">/[\n][\r]*[\n]/m</span>
</span><span class='line'>       <span class="vi">@parsed</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>       <span class="nb">p</span> <span class="n">data</span>
</span><span class='line'>       <span class="n">close_connection</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">def</span> <span class="nf">unbind</span>
</span><span class='line'>     <span class="nb">puts</span> <span class="s2">&quot;A connection has terminated&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">urls</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">url</span><span class="o">|</span>
</span><span class='line'>     <span class="k">begin</span>
</span><span class='line'>       <span class="no">EventMachine</span><span class="o">::</span><span class="n">connect</span> <span class="n">url</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="no">DumbHttpClient</span>
</span><span class='line'>     <span class="k">rescue</span> <span class="no">EventMachine</span><span class="o">::</span><span class="no">ConnectionError</span>
</span><span class='line'>       <span class="nb">p</span> <span class="s2">&quot;Something wrong with </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>     <span class="nb">p</span> <span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="nb">puts</span> <span class="s2">&quot;The event loop has ended&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simple example which just send/receive data from web. It works well only if you try to grab ~1000 websites. Before gets result its going through <em>.each</em> and only after finish this loop starts sending data and receive_data. Version with BATCH_SIZE that I did yesterday pretend to create queue and that&#8217;s why it works with 1_000_000 urls, but after first hundred requests speed goes down.</p>

<p>Then I&#8217;ve read about <a href="http://rdoc.info/github/eventmachine/eventmachine/master/EventMachine/Iterator">EM::Iterator</a> and did this example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-http&#39;</span>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;1.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="no">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">kqueue</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="no">EventMachine</span><span class="o">.</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">add_periodic_timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">batch</span><span class="p">,</span> <span class="n">urls</span> <span class="o">=</span> <span class="n">urls</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="p">(</span><span class="no">BATCH_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span><span class="p">,</span> <span class="p">(</span><span class="n">urls</span><span class="o">[</span><span class="no">BATCH_SIZE</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">||</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'>    <span class="no">EM</span><span class="o">::</span><span class="no">Iterator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">url</span><span class="p">,</span><span class="n">iter</span><span class="o">|</span>
</span><span class='line'>      <span class="n">http</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="ss">:connect_timeout</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">:inactivity_timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">http</span><span class="o">.</span><span class="n">response_header</span><span class="o">[</span><span class="s1">&#39;SERVER&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">iter</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">pending</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">urls</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2"> - </span><span class="si">#{</span><span class="n">http</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">iter</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">pending</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">urls</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">pending</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">iter</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">pending</span><span class="si">}</span><span class="s2"> pending. </span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures&quot;</span>
</span><span class='line'>    <span class="nb">p</span> <span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Works, but speed not as I expected. Network used only 200kb/s and 1mbit once at the pick. So, that means parallels works not as we want, we want to use network as much as possible.</p>

<p>Then I&#8217;ve read about <a href="https://github.com/igrigorik/em-synchrony">em-synchrony</a> and did this example of crawler (ruby 1.9.3 and em-synchrony):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-synchrony&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-synchrony/em-http&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;10k.csv&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">gets</span><span class="p">)</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">p</span> <span class="n">urls</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">synchrony</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">concurrency</span> <span class="o">=</span> <span class="mi">200</span>
</span><span class='line'>  <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="c1"># iterator will execute async blocks until completion, .each, .inject also work!</span>
</span><span class='line'>  <span class="n">results</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">Synchrony</span><span class="o">::</span><span class="no">Iterator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">concurrency</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">url</span><span class="p">,</span> <span class="n">iter</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># fire async requests, on completion advance the iterator</span>
</span><span class='line'>      <span class="n">http</span> <span class="o">=</span> <span class="no">EventMachine</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">aget</span>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">iter</span><span class="o">.</span><span class="n">return</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures, connection </span><span class="si">#{</span><span class="no">EM</span><span class="o">::</span><span class="n">connection_count</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">iter</span><span class="o">.</span><span class="n">return</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>
</span><span class='line'>        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="n">results</span> <span class="c1"># all completed requests</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">.</span><span class="n">stop</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures in </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2"> s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since I&#8217;ve done a lot of examples I&#8217;ve learned a good lesson - never block the main EM.run {}:</p>

<ul>
<li>no sleep(1)</li>
<li>no long loops like I did 10_000.each</li>
<li>no blocking I/O</li>
</ul>


<p>concurrency = 1000</p>

<p>935 successful, 65 failures in 186.044609 s</p>

<p>concurrency = 50</p>

<p>957 successful, 43 failures in 67.982429 s</p>

<p>concurrency = 300</p>

<p>956 successful, 44 failures in 26.822961 s</p>

<p>In the next post I&#8217;m going to try EM::Deferrable and will see how it will work. Still don&#8217;t have good solution, so, keep digging. I just wanna get the shit out of my internet connection, like using bandwidth as can as possible ;)</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-21T14:47:00-07:00" pubdate data-updated="true">Apr 21<span>st</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/concurrency/'>concurrency</a>, <a class='category' href='/blog/categories/crawl/'>crawl</a>, <a class='category' href='/blog/categories/eventmachine/'>eventmachine</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/19/ruby-with-eventmachine-and-jruby-with-real-threads/">Ruby With EventMachine and JRuby With Real Threads: Part I</a></h1>
	<div class="entry-content">
		<p>Welcome to the world of extremely high scalability, performance and stability for the most demanding production environments. Today I&#8217;m going to learn and describe a little bit about EventMachine that is a high perfomance implementation of the <a href="http://en.wikipedia.org/wiki/Reactor_pattern">Reactor Pattern</a>.</p>

<p>Basically, we can use it for critical networked applications, including web servers and proxies, email and IM production systems, authentication/authorization processors, and many more. In my case in attracted me with simplicity of using with tons tcp connections for scanning web as example.</p>

<p>Recommended links:</p>

<ul>
<li>[1] <a href="http://rubyeventmachine.com/">http://rubyeventmachine.com/</a></li>
<li>[2] <a href="http://eventmachine.rubyforge.org/">http://eventmachine.rubyforge.org/</a></li>
<li>[3] <a href="http://peepcode.com">peepcode screencast about eventmachine</a></li>
</ul>


<p>Simple example of Echo server (telnet 127.0.0.1 8000):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;eventmachine&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">EchoServer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;connected&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">close_connection_after_writing</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/quit/</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;=&gt; you sent: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">start_server</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="no">EchoServer</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;runnning echo server on 8000&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is example of web scanner (we have to use asynchronous libraries with EventMachine, you can&#8217;t use any I/O blocking process in EM.run {} environment):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-http-request&#39;</span> <span class="c1"># asynchronous version</span>
</span><span class='line'>
</span><span class='line'><span class="n">pending</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="mi">1000</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
</span><span class='line'>      <span class="n">http</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">http</span><span class="o">.</span><span class="n">response_header</span><span class="o">[</span><span class="s1">&#39;SERVER&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">pending</span> <span class="o">&lt;</span> <span class="mi">1</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2"> - </span><span class="si">#{</span><span class="n">http</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">pending</span> <span class="o">&lt;</span> <span class="mi">1</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Took </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is not good example, because it doesn&#8217;t work well. When I&#8217;m trying to run its only gets 355 request succeed. I don&#8217;t know yet why (my version is many connection in the same time and it&#8217;s just doesn&#8217;t process all of them) but my supposition is we should use batch, like 100 connection in the same time. Let&#8217;s try to implement it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;em-http-request&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">urls</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="mi">10000</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">urls</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;http://127.0.0.1&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
</span><span class='line'><span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">t1</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="no">EM</span><span class="o">.</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="no">EM</span><span class="o">.</span><span class="n">add_periodic_timer</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># urls = urls[BATCH_SIZE..-1] every loop. 1000, 900, 800 .. 200, 100, 0</span>
</span><span class='line'>    <span class="n">batch</span><span class="p">,</span> <span class="n">urls</span> <span class="o">=</span> <span class="n">urls</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="p">(</span><span class="no">BATCH_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">]</span><span class="p">,</span> <span class="p">(</span><span class="n">urls</span><span class="o">[</span><span class="no">BATCH_SIZE</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">||</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">batch</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">url</span><span class="o">|</span>
</span><span class='line'>      <span class="n">http</span> <span class="o">=</span> <span class="no">EM</span><span class="o">::</span><span class="no">HttpRequest</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">callback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - </span><span class="si">#{</span><span class="n">http</span><span class="o">.</span><span class="n">response_header</span><span class="o">[</span><span class="s1">&#39;SERVER&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">successes</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">pending</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">urls</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">http</span><span class="o">.</span><span class="n">errback</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2"> - </span><span class="si">#{</span><span class="n">http</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">failures</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="n">pending</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="no">EM</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">pending</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">urls</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">pending</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">pending</span><span class="si">}</span><span class="s2"> pending&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">successes</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">#{</span><span class="n">failures</span><span class="si">}</span><span class="s2"> failures in </span><span class="si">#{</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="si">}</span><span class="s2">s&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We added BATCH_SIZE and it helped to control the queue of requests, so if we increase BATCH_SIZE = 1000 then we will get same problem: 351 successful, 649 failures in 5.57171 s.</p>

<p>BATCH_SIZE = 100 # => 1000 successful, 0 failures in 1.215148 s</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-19T12:53:00-07:00" pubdate data-updated="true">Apr 19<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/eventmachine/'>eventmachine</a>, <a class='category' href='/blog/categories/green-threads/'>green threads</a>, <a class='category' href='/blog/categories/jruby/'>jruby</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/threads/'>threads</a>


</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/blog/2012/04/16/freedom-of-information/">Freedom of Information</a></h1>
	<div class="entry-content">
		<p>Today I decided to try EventMachine in action. EventMachine provides a fast, lightweight framework for implementing Ruby programs that can use the network to communicate with other processes. As usual I can&#8217;t just repeat &#8220;hello world&#8221; examples, like here is a fully-functional echo server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;eventmachine&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">EchoServer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_init</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;-- someone connected to the echo server!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">receive_data</span> <span class="n">data</span>
</span><span class='line'>    <span class="n">send_data</span> <span class="s2">&quot;&gt;&gt;&gt;you sent: </span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">close_connection</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/quit/i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">unbind</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;-- someone disconnected from the echo server!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">EventMachine</span><span class="o">::</span><span class="n">start_server</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8081</span><span class="p">,</span> <span class="no">EchoServer</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I need something to work on, something valuable. I&#8217;ve thought about <a href="http://en.wikipedia.org/wiki/Internet_censorship_in_the_People's_Republic_of_China">censorship in internet</a>, blocking <a href="http://en.wikipedia.org/wiki/Censorship_of_Twitter">twitter</a>, <a href="http://en.wikipedia.org/wiki/Censorship_of_YouTube">youtube</a> and <a href="http://en.wikipedia.org/wiki/Censorship#Internet">other</a> and want to build proxy, something like tor, but just for few websites like twitter, facebook and youtube for example.</p>

<h2>idea</h2>

<p>To build small app on ruby which shoud be easy to install and has two modes. <strong>Aides</strong> (servers) and <strong>victims</strong> (client) mode. Aides will provide a proxy connection, but for security reason only to access to the lists of allowed websites, so nobody will not use it to do some bad things, only victims who are looking for access to twitter/facebook/youtube will able to access and use it.</p>

<p><img src="http://pix.am/y55O.png" alt="test" /></p>

<p>So, people in any country install the server and people can get/update information trough their internet connection if somebody will blocked twitter as example. If direct connection doesn&#8217;t work, install ruby script and activate victim mode, connect to blocked website through Aides servers.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-04-16T14:07:00-07:00" pubdate data-updated="true">Apr 16<span>th</span>, 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/eventmachine/'>eventmachine</a>, <a class='category' href='/blog/categories/idea/'>idea</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div></article>

<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2013

    khakimov

</footer>
	<script src="/javascripts/slash.js"></script>
<script type="text/javascript">
var _hcp = _hcp || {};
_hcp.widget_id = 2313;
_hcp.widget = "Stream";
(function() { 
var hcc = document.createElement("script"); hcc.type = "text/javascript"; hcc.async = true;
hcc.src = ("https:" == document.location.protocol ? "https" : "http")+"://widget.hypercomments.com/apps/js/hc.js";
var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hcc, s.nextSibling); 
})();</script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-31552911-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>